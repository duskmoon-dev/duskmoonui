---
import CodeBlock from './CodeBlock.astro';

interface Props {
  title: string;
  description?: string;
  code: string;
  showCode?: boolean;
  defaultTab?: 'preview' | 'code';
}

const { title, description, code, showCode = true, defaultTab = 'preview' } = Astro.props;

// Generate unique ID for ARIA linking
const showcaseId = `showcase-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="component-showcase" data-showcase data-default-tab={defaultTab}>
  <div class="showcase-header">
    <div class="showcase-header-content">
      <h3 class="showcase-title">{title}</h3>
      {description && <p class="showcase-description">{description}</p>}
    </div>

    {showCode && (
      <div class="showcase-tabs" role="tablist" aria-label="Component example views">
        <button
          role="tab"
          id={`${showcaseId}-preview-tab`}
          aria-selected={defaultTab === 'preview' ? 'true' : 'false'}
          aria-controls={`${showcaseId}-preview-panel`}
          tabindex={defaultTab === 'preview' ? '0' : '-1'}
          data-tab="preview"
          class="showcase-tab"
        >
          Preview
        </button>
        <button
          role="tab"
          id={`${showcaseId}-code-tab`}
          aria-selected={defaultTab === 'code' ? 'true' : 'false'}
          aria-controls={`${showcaseId}-code-panel`}
          tabindex={defaultTab === 'code' ? '0' : '-1'}
          data-tab="code"
          class="showcase-tab"
        >
          Code
        </button>
      </div>
    )}
  </div>

  <div
    role="tabpanel"
    id={`${showcaseId}-preview-panel`}
    aria-labelledby={`${showcaseId}-preview-tab`}
    data-panel="preview"
    class="showcase-preview"
    hidden={showCode && defaultTab !== 'preview'}
  >
    <Fragment set:html={code} />
  </div>

  {showCode && (
    <div
      role="tabpanel"
      id={`${showcaseId}-code-panel`}
      aria-labelledby={`${showcaseId}-code-tab`}
      data-panel="code"
      class="showcase-code"
      hidden={defaultTab !== 'code'}
    >
      <CodeBlock code={code} language="html" />
    </div>
  )}
</div>

<style>
  .component-showcase {
    margin: 2rem 0;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 0.5rem;
    overflow: hidden;
    background: var(--surface, #ffffff);
  }

  .showcase-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border, #e5e7eb);
    background: var(--surface-variant, #f9fafb);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .showcase-header-content {
    flex: 1;
    min-width: 200px;
  }

  .showcase-title {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--foreground, #1f2937);
  }

  .showcase-description {
    margin: 0.5rem 0 0;
    color: var(--foreground-muted, #6b7280);
    font-size: 0.9rem;
  }

  /* Tab list styles */
  .showcase-tabs {
    display: flex;
    gap: 0.25rem;
    background: var(--surface, #ffffff);
    padding: 0.25rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border, #e5e7eb);
  }

  .showcase-tab {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--foreground-muted, #6b7280);
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
    min-height: 44px;
    min-width: 44px;
  }

  .showcase-tab:hover {
    color: var(--foreground, #1f2937);
    background: var(--surface-variant, #f3f4f6);
  }

  .showcase-tab:focus-visible {
    outline: 2px solid var(--primary, #3b82f6);
    outline-offset: 2px;
  }

  .showcase-tab[aria-selected="true"] {
    color: var(--primary, #3b82f6);
    background: var(--primary-container, #dbeafe);
  }

  /* Panel styles */
  .showcase-preview {
    padding: 2rem;
    background: var(--background, #ffffff);
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .showcase-code {
    background: var(--surface, #f9fafb);
  }

  /* Hidden panel - using hidden attribute */
  [hidden] {
    display: none !important;
  }

  /* Progressive enhancement: show both panels stacked when JS disabled */
  @supports not (selector(:has(*))) {
    .component-showcase:not([data-enhanced]) .showcase-preview,
    .component-showcase:not([data-enhanced]) .showcase-code {
      display: block !important;
    }
    .component-showcase:not([data-enhanced]) .showcase-preview {
      border-bottom: 1px solid var(--border, #e5e7eb);
    }
  }

  /* Responsive styles for mobile */
  @media (max-width: 640px) {
    .showcase-header {
      flex-direction: column;
      padding: 1rem;
    }

    .showcase-tabs {
      width: 100%;
      justify-content: stretch;
    }

    .showcase-tab {
      flex: 1;
      text-align: center;
    }

    .showcase-preview {
      padding: 1rem;
    }
  }
</style>

<script>
  // Module-level preference that persists within page session
  let preferredTab: 'preview' | 'code' = 'preview';

  function initShowcase(showcase: HTMLElement) {
    const tabs = showcase.querySelectorAll<HTMLButtonElement>('[data-tab]');
    const panels = showcase.querySelectorAll<HTMLElement>('[data-panel]');

    if (tabs.length === 0) return; // No tabs (showCode=false)

    // Mark as enhanced for progressive enhancement CSS
    showcase.setAttribute('data-enhanced', 'true');

    // Apply user's preferred tab if different from default
    const defaultTab = showcase.dataset.defaultTab || 'preview';
    if (preferredTab !== defaultTab) {
      const targetTab = showcase.querySelector<HTMLButtonElement>(`[data-tab="${preferredTab}"]`);
      if (targetTab) {
        activateTab(targetTab, tabs, panels);
      }
    }

    // Tab click handling
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        activateTab(tab, tabs, panels);
        preferredTab = tab.dataset.tab as 'preview' | 'code';
      });
    });

    // Keyboard navigation
    const tablist = showcase.querySelector('[role="tablist"]');
    if (tablist) {
      tablist.addEventListener('keydown', (e: Event) => {
        const event = e as KeyboardEvent;
        const tabsArray = Array.from(tabs);
        const currentIndex = tabsArray.findIndex(t => t.getAttribute('aria-selected') === 'true');
        let newIndex = currentIndex;

        switch (event.key) {
          case 'ArrowLeft':
            newIndex = currentIndex === 0 ? tabsArray.length - 1 : currentIndex - 1;
            event.preventDefault();
            break;
          case 'ArrowRight':
            newIndex = currentIndex === tabsArray.length - 1 ? 0 : currentIndex + 1;
            event.preventDefault();
            break;
          case 'Home':
            newIndex = 0;
            event.preventDefault();
            break;
          case 'End':
            newIndex = tabsArray.length - 1;
            event.preventDefault();
            break;
          default:
            return;
        }

        if (newIndex !== currentIndex) {
          activateTab(tabsArray[newIndex], tabs, panels);
          tabsArray[newIndex].focus();
          preferredTab = tabsArray[newIndex].dataset.tab as 'preview' | 'code';
        }
      });
    }
  }

  function activateTab(
    targetTab: HTMLButtonElement,
    tabs: NodeListOf<HTMLButtonElement>,
    panels: NodeListOf<HTMLElement>
  ) {
    const targetPanel = targetTab.dataset.tab;

    // Update tab states
    tabs.forEach(tab => {
      const isSelected = tab === targetTab;
      tab.setAttribute('aria-selected', isSelected ? 'true' : 'false');
      tab.setAttribute('tabindex', isSelected ? '0' : '-1');
    });

    // Update panel visibility
    panels.forEach(panel => {
      panel.hidden = panel.dataset.panel !== targetPanel;
    });
  }

  // Initialize all showcases on page load
  function initAllShowcases() {
    document.querySelectorAll<HTMLElement>('[data-showcase]').forEach(showcase => {
      if (!showcase.hasAttribute('data-enhanced')) {
        initShowcase(showcase);
      }
    });
  }

  // Position popovers relative to their triggers
  function initPopoverPositioning() {
    function positionPopover(popover: HTMLElement, trigger: HTMLElement) {
      // Wait for popover to be visible and have dimensions
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const triggerRect = trigger.getBoundingClientRect();
          const popoverRect = popover.getBoundingClientRect();

          // Position below the trigger
          let top = triggerRect.bottom + 4;
          let left = triggerRect.left;

          // Adjust if popover would go off-screen right
          if (left + popoverRect.width > window.innerWidth - 16) {
            left = window.innerWidth - popoverRect.width - 16;
          }

          // Adjust if popover would go off-screen bottom
          if (top + popoverRect.height > window.innerHeight - 16) {
            top = triggerRect.top - popoverRect.height - 4;
          }

          // Ensure minimum left position
          left = Math.max(16, left);

          popover.style.position = 'fixed';
          popover.style.inset = 'unset';
          popover.style.transform = 'none';
          popover.style.top = `${top}px`;
          popover.style.left = `${left}px`;
        });
      });
    }

    // Listen for clicks on trigger buttons
    document.addEventListener('click', (event: Event) => {
      const target = event.target as HTMLElement;
      const trigger = target.closest('[popovertarget]') as HTMLElement;

      if (trigger) {
        const popoverId = trigger.getAttribute('popovertarget');
        const popover = document.getElementById(popoverId || '');

        if (popover && popover.hasAttribute('popover')) {
          // Position after a short delay to let popover open
          setTimeout(() => {
            if (popover.matches(':popover-open')) {
              positionPopover(popover, trigger);
            }
          }, 10);
        }
      }
    });
  }

  // Run on initial load
  initAllShowcases();
  initPopoverPositioning();

  // Re-run after Astro page transitions (if using View Transitions)
  document.addEventListener('astro:page-load', () => {
    initAllShowcases();
    initPopoverPositioning();
  });
</script>
